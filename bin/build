#!/usr/bin/env bash

set -eou pipefail

buildpack_dir=${1-""}
app_dir=${2-$(pwd)}
pre_command=${3-""}

if [ "$buildpack_dir" == "" ]; then
  echo "usage: $0 <buildpack_dir> <app_dir>"
  exit 1
fi

mkdir -p `pwd`/tmp/cache

docker run \
--name postgresdb \
-d postgres

docker run \
--name buildpack \
--link postgresdb:postgres \
-v $buildpack_dir:/var/vcap/buildpack \
-v $app_dir:/var/vcap/src \
-v `pwd`:/var/vcap/dockery \
-v `pwd`/tmp/cache:/home/vcap/tmp \
-u vcap \
-e PORT=5000 \
-e HOME=/home/vcap/app \
-e TMPDIR=/home/vcap/tmp \
-e DATABASE_URL="postgres://postgres:postgres@postgres:5432/postgres" \
-p 5000:5000 \
-i -t dockery-build bash -c /var/vcap/dockery/bin/run "$pre_command"
