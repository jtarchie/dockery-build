#!/usr/bin/env bash

app_dir=""
buildpack_dir=""
port=5000
unique_id=$(date +%s)

app_args=()

while getopts ":a:b:c:e:p:u:" o; do
  case "${o}" in
    a)
      app_dir=${OPTARG};;
    b)
      buildpack_dir=${OPTARG};;
    c)
      app_args+=(" -c ${OPTARG}");;
    e)
      app_args+=(" -e $OPTARG");;
    p)
      port=${OPTARG};;
    u)
      unique_id=${OPTARG};;
  esac
done


if [ "$buildpack_dir" == "" ]; then
  echo "usage: $0 -b <buildpack_dir> -a <app_dir> [-c start_command] [-p 5000] [-e NAME=VALUE] [-u unique_id]"
  exit 1
fi

mkdir -p "$(pwd)/tmp/cache"

docker run \
--name "postgresdb-$unique_id" \
-d postgres

docker run \
--name "buildpack-$unique_id" \
--link "postgresdb-$unique_id:postgres" \
-v "$buildpack_dir:/var/vcap/buildpack:ro" \
-v "$app_dir:/var/vcap/src:ro" \
-v "$(pwd)/:/var/vcap/dockery:ro" \
-v "$(pwd)/tmp/cache:/home/vcap/tmp" \
-p "$port:3000" \
-it dockery-build-lucid /var/vcap/dockery/bin/run $(printf "%q" "${app_args[*]}")
