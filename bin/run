#!/usr/bin/env bash

pre_command=${1-""}

#fail fast
set -eo pipefail

cp -r /var/vcap/src /home/vcap/app
cd /home/vcap/app

#run buildpack
/var/vcap/buildpack/bin/detect "$(pwd)" "$BUILDPACK_CACHE_DIR"
/var/vcap/buildpack/bin/compile "$(pwd)" "$BUILDPACK_CACHE_DIR"
release=$(/var/vcap/buildpack/bin/release "$(pwd)" "$BUILDPACK_CACHE_DIR")

# source any environment scripts
source .profile.d/*

if [ "$pre_command" != "" ]; then
  eval $pre_command
fi

# determine if web process defined in release step
web=$(ruby -ryaml -e "puts YAML.load(\"$release\")['default_process_types']['web'] rescue ''")
if [ "$web" != "" ]; then
  eval $web
fi
