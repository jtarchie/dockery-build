#!/usr/bin/env ruby

require 'fileutils'
require 'shellwords'

base_dir = File.expand_path(File.join(File.dirname(__FILE__), '..'))
buildpack_dir = ARGV[0] || ""
app_dir = ARGV[1] || Dir.pwd
start_command = ARGV[2] || ""
rest_args = ARGV[3..-1] || []
timestamp=Time.now.to_f.to_s.gsub('.','')

if buildpack_dir == ""
  puts "usage: $0 <buildpack_dir> <app_dir>"
  exit 1
end

command = ['/var/vcap/dockery/bin/run']
command += ['-c', start_command] unless start_command.empty?
command += rest_args

FileUtils.mkdir_p "#{base_dir}/tmp/cache"
exec(<<-SHELL)
docker run \
--name postgresdb-#{timestamp} \
-d postgres

docker run \
--name buildpack-#{timestamp} \
--link postgresdb-#{timestamp}:postgres \
-v #{buildpack_dir}:/var/vcap/buildpack:ro \
-v #{app_dir}:/var/vcap/src:ro \
-v #{base_dir}/:/var/vcap/dockery:ro \
-v #{base_dir}/tmp/cache:/home/vcap/tmp \
-p 5000:5000 \
-it dockery-build-lucid #{command.shelljoin}

docker rm -f buildpack-#{timestamp} postgresdb-#{timestamp}
SHELL
